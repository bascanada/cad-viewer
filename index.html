<!DOCTYPE html>
<html lang="en" style="width: 100%; height: 100%;">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CAD Viewer Demo - Drag & Drop STL/3MF Files</title>
    
    <script type="module" src="/src/main.ts"></script>
    <style>
        .demo-container {
            position: relative;
            width: 100%;
            height: 100%;
        }
        
        .drag-drop-overlay {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 120px;
            height: 120px;
            background: rgba(42, 42, 42, 0.95);
            border: 2px dashed #666;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(5px);
        }
        
        .gizmo-scale-control {
            position: absolute;
            top: 160px;
            right: 20px;
            width: 120px;
            background: rgba(42, 42, 42, 0.95);
            border: 2px solid #666;
            border-radius: 8px;
            padding: 12px;
            z-index: 1000;
            backdrop-filter: blur(5px);
            box-sizing: border-box; /* Include padding in width calculation */
        }
        
        .persistence-control {
            position: absolute;
            top: 280px;
            right: 20px;
            width: 120px;
            background: rgba(42, 42, 42, 0.95);
            border: 2px solid #666;
            border-radius: 8px;
            padding: 12px;
            z-index: 1000;
            backdrop-filter: blur(5px);
            box-sizing: border-box;
        }
        
        .persistence-button {
            width: 100%;
            padding: 6px;
            margin-bottom: 6px;
            background: #444;
            color: #eee;
            border: 1px solid #666;
            border-radius: 4px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            font-size: 10px;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .persistence-button:hover {
            background: #555;
        }
        
        .persistence-button:last-child {
            margin-bottom: 0;
        }
        
        .control-label {
            color: #eee;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            font-size: 12px;
            font-weight: 500;
            margin-bottom: 8px;
            text-align: center;
        }
        
        .scale-slider {
            width: 100%;
            margin-bottom: 8px;
        }
        
        .scale-value {
            color: #aaa;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            font-size: 10px;
            text-align: center;
        }
        
        .drag-drop-overlay:hover {
            background: rgba(52, 52, 52, 0.95);
            border-color: #888;
        }
        
        .drag-drop-overlay.drag-over {
            background: rgba(15, 118, 110, 0.95);
            border-color: #14b8a6;
            border-style: solid;
        }
        
        .drag-drop-text {
            color: #eee;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            font-size: 12px;
            font-weight: 500;
            margin-bottom: 4px;
            text-align: center;
            line-height: 1.2;
        }
        
        .drag-drop-subtext {
            color: #aaa;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            font-size: 10px;
            text-align: center;
            line-height: 1.2;
        }
        
        .file-input {
            display: none;
        }
    </style>
</head>
<body style="height: 100%; width: 100%; margin: 0;">
    <div class="demo-container">
        <div class="drag-drop-overlay" id="dragDropArea">
            <div class="drag-drop-text">Drop STL or 3MF files here</div>
            <div class="drag-drop-subtext">or click to browse</div>
        </div>
        
        <div class="gizmo-scale-control">
            <div class="control-label">Gizmo Scale</div>
            <input type="range" class="scale-slider" id="gizmoScaleSlider" 
                   min="0.5" max="2.0" step="0.1" value="1.0">
            <div class="scale-value" id="scaleValue">1.0x</div>
        </div>
        
        <div class="persistence-control">
            <div class="control-label">Persistence</div>
            <button class="persistence-button" id="clearStateBtn">Clear State</button>
            <button class="persistence-button" id="showStateBtn">Show State</button>
            <button class="persistence-button" id="reloadPageBtn">Reload Page</button>
            <div class="control-label" style="margin-top: 8px; font-size: 10px;">ID: viewer-1</div>
        </div>
        
        <input type="file" class="file-input" id="fileInput" accept=".stl,.3mf" multiple="false">
        
        <cad-viewer id="cad-viewer" viewerBackgroundColor="#1e1e1e" gizmoScale="1.0" persistenceId="viewer-1"></cad-viewer>
    </div>
    <script>
        const cadViewer = document.getElementById('cad-viewer');
        const dragDropArea = document.getElementById('dragDropArea');
        const fileInput = document.getElementById('fileInput');
        const gizmoScaleSlider = document.getElementById('gizmoScaleSlider');
        const scaleValue = document.getElementById('scaleValue');
        const clearStateBtn = document.getElementById('clearStateBtn');
        const showStateBtn = document.getElementById('showStateBtn');
        const reloadPageBtn = document.getElementById('reloadPageBtn');
        
        // Persistence controls
        clearStateBtn.addEventListener('click', () => {
            cadViewer.clearSavedState();
            const persistenceId = cadViewer.getAttribute('persistenceId') || 'default';
            console.log('Saved state cleared for ID:', persistenceId);
            alert(`Saved state cleared for ID: ${persistenceId}! The viewer will start fresh on next reload.`);
        });
        
        showStateBtn.addEventListener('click', () => {
            const state = cadViewer.getSavedState();
            const persistenceId = cadViewer.getAttribute('persistenceId') || 'default';
            console.log('Current saved state for', persistenceId, ':', state);
            if (state) {
                alert(`Saved state found (ID: ${persistenceId}):\n- Model: ${state.model ? 'Yes' : 'No'}\n- Camera Mode: ${state.camera.mode}\n- Wireframe: ${state.wireframe}\n- Position: (${state.camera.position.x.toFixed(2)}, ${state.camera.position.y.toFixed(2)}, ${state.camera.position.z.toFixed(2)})`);
            } else {
                alert(`No saved state found for ID: ${persistenceId}`);
            }
        });
        
        reloadPageBtn.addEventListener('click', () => {
            location.reload();
        });
        
        // Gizmo scale control
        gizmoScaleSlider.addEventListener('input', (e) => {
            const scale = parseFloat(e.target.value);
            cadViewer.setAttribute('gizmoScale', scale.toString());
            scaleValue.textContent = `${scale.toFixed(1)}x`;
        });
        
        // Set initial slider value to match the cad-viewer gizmo-scale attribute
        const initialScale = parseFloat(cadViewer.getAttribute('gizmoScale') || '1.0');
        gizmoScaleSlider.value = initialScale.toString();
        scaleValue.textContent = `${initialScale.toFixed(1)}x`;
        
        // Set initial demo model
        cadViewer.payload = `
solid OpenSCAD_Model
  facet normal -0 0 1
    outer loop
      vertex 0 10 10
      vertex 10 0 10
      vertex 10 10 10
    endloop
  endfacet
  facet normal 0 0 1
    outer loop
      vertex 10 0 10
      vertex 0 10 10
      vertex 0 0 10
    endloop
  endfacet
  facet normal 0 0 -1
    outer loop
      vertex 0 0 0
      vertex 10 10 0
      vertex 10 0 0
    endloop
  endfacet
  facet normal -0 0 -1
    outer loop
      vertex 10 10 0
      vertex 0 0 0
      vertex 0 10 0
    endloop
  endfacet
  facet normal 0 -1 0
    outer loop
      vertex 0 0 0
      vertex 10 0 10
      vertex 0 0 10
    endloop
  endfacet
  facet normal 0 -1 -0
    outer loop
      vertex 10 0 10
      vertex 0 0 0
      vertex 10 0 0
    endloop
  endfacet
  facet normal 1 -0 0
    outer loop
      vertex 10 0 10
      vertex 10 10 0
      vertex 10 10 10
    endloop
  endfacet
  facet normal 1 0 0
    outer loop
      vertex 10 10 0
      vertex 10 0 10
      vertex 10 0 0
    endloop
  endfacet
  facet normal 0 1 -0
    outer loop
      vertex 10 10 0
      vertex 0 10 10
      vertex 10 10 10
    endloop
  endfacet
  facet normal 0 1 0
    outer loop
      vertex 0 10 10
      vertex 10 10 0
      vertex 0 10 0
    endloop
  endfacet
  facet normal -1 0 0
    outer loop
      vertex 0 0 0
      vertex 0 10 10
      vertex 0 10 0
    endloop
  endfacet
  facet normal -1 -0 0
    outer loop
      vertex 0 10 10
      vertex 0 0 0
      vertex 0 0 10
    endloop
  endfacet
endsolid OpenSCAD_Model`;

        // Utility functions
        function getFileExtension(filename) {
            return filename.toLowerCase().split('.').pop();
        }
        
        function isValidFileType(filename) {
            const extension = getFileExtension(filename);
            return extension === 'stl' || extension === '3mf';
        }
        
        function loadFile(file) {
            if (!isValidFileType(file.name)) {
                console.warn('Please select a valid STL or 3MF file.');
                return;
            }
            
            const reader = new FileReader();
            const extension = getFileExtension(file.name);
            
            reader.onload = function(e) {
                try {
                    let payload = '';
                    
                    if (extension === 'stl') {
                        // For STL files, we need to read as text
                        payload = e.target.result;
                    } else if (extension === '3mf') {
                        // For 3MF files, we need to handle binary data
                        const arrayBuffer = e.target.result;
                        const uint8Array = new Uint8Array(arrayBuffer);
                        payload = String.fromCharCode.apply(null, uint8Array);
                    }
                    
                    // Update CAD viewer
                    cadViewer.payload = payload;
                    cadViewer.payloadType = extension;

                    console.log("loading ", extension);
                    
                } catch (error) {
                    console.error('Error loading file:', error);
                }
            };
            
            reader.onerror = function() {
                console.error('Error reading file. Please try again.');
            };
            
            // Read file based on type
            if (extension === 'stl') {
                reader.readAsText(file);
            } else if (extension === '3mf') {
                reader.readAsArrayBuffer(file);
            }
        }
        
        // Drag and drop event handlers
        dragDropArea.addEventListener('click', () => {
            fileInput.click();
        });
        
        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                loadFile(file);
            }
        });
        
        dragDropArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            e.stopPropagation();
            dragDropArea.classList.add('drag-over');
        });
        
        dragDropArea.addEventListener('dragleave', (e) => {
            e.preventDefault();
            e.stopPropagation();
            dragDropArea.classList.remove('drag-over');
        });
        
        dragDropArea.addEventListener('drop', (e) => {
            e.preventDefault();
            e.stopPropagation();
            dragDropArea.classList.remove('drag-over');
            
            const files = Array.from(e.dataTransfer.files);
            if (files.length > 0) {
                loadFile(files[0]);
            }
        });
        
        // Prevent default drag behaviors on the entire page
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            document.addEventListener(eventName, (e) => {
                e.preventDefault();
                e.stopPropagation();
            });
        });
    </script>
</body>
</html>
